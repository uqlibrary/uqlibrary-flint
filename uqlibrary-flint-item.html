<link rel="import" href="../uqlibrary-elements/0.5.4/lib/vulcanized-flint.html">
<polymer-element name="uqlibrary-flint-item" attributes="item">

<template>
  <link rel="stylesheet" href="../uqlibrary-elements/resources/theme/element.css">

  <ul class="three-line-icon-list">
    <li class="list-item header border" style="padding-bottom: 0px; margin-top: 0px; padding: 24px" horizontal layout>
        <paper-icon-button class="playerButton" icon="{{isPlaying ? 'av:pause-circle-outline' : 'av:play-circle-outline'}}" on-click="{{toggleAudioPlay}}"></paper-icon-button>
        <div class="content" style="margin-left: 0px;" flex horizontal layout center-centre>
        <div>
        {{item.title_t}}
        </div>
      </div>
      <div>
        <core-a11y-keys id="a11yCloseButton" target="{{$.closeButton}}" keys="{{keyboardNavigationKeys}}"
                        on-keys-pressed="{{ a11yKeyPressed }}"></core-a11y-keys>
        <paper-icon-button aria-label="Close panel" icon="close" id="closeButton" on-click="{{backButtonHandler}}"></paper-icon-button>
      </div>
    </li>
  </ul>

  <ul class="two-line-list" style="padding-bottom: 100px;">

    <li class="list-item" horizontal layout>
      <div class="content" flex>
        <div class="line1">Language</div>
        <div class="line2" id="itemLanguage">{{item.subject_mi_lookup[0]}}</div>
      </div>

    </li>

    <li class="list-item">
      <div class="content">
        <div class="line1">Voice</div>
        <div class="line2">{{item.contributor_mt[0]}}</div>
      </div>
    </li>

    <!--<li class="list-item">-->
      <!--<div class="content">-->
        <!--<div class="line1">Authors</div>-->
        <!--<div class="line2">{{item.author_mt[0]}}</div>-->
      <!--</div>-->
    <!--</li>-->

    <li class="list-item border">
      <div class="content">
        <div class="line2"><a href="https://espace.library.uq.edu.au/view/{{item.id}}" target="_blank">View this item's full record</a></div>
      </div>
    </li>

    <template if="{{item.transcript_t}}">
      <li class="list-item border" style="height: auto; overflow:visible;">

        <div class="content">
          <div class="line1">Transcript</div>
          <span class="text">
            <ul>
              <template repeat="{{line in item.lines}}">
                <li>{{ line }}</li>
              </template>
            </ul>
          </span>
        </div>
    </li>
    </template>

    <li class="list-item">
      <div class="text-container text-center">
        <paper-button id="feedbackButton" class="colored" raised on-tap="{{showFeedback}}">Feedback</paper-button>
      </div>
    </li>

    </ul>

</template>

<script>
  (function() {
    Polymer('uqlibrary-flint-item', {

      // Accessibility issues fixes
      keyboardNavigationKeys: 'space enter',

      playingId: null,

      a11yKeyPressed: function(source, event) {
        if (source.path && source.path.length > 0 && source.path[0].target) {
          source.path[0].target.click();
        }
      },

      itemChanged: function(oldValue, newValue) {
        //split transcript into lines based on HTML breaks
        if (this.item && this.item.transcript_t && this.item.transcript_t) {
          this.item.lines = this.item.transcript_t.split('<br \/>').filter(function(line) { return line; });
        }
      },

      ready: function() {
        this.item = {};
        var that = this;
        document.addEventListener('uqlibrary-flint-response-current-audio', function(e) {
            if(e.detail.audio != null && that.item.mp3 == e.detail.audio.src) {
                that.isPlaying = true;
            } else {
              that.isPlaying = false;
            }
        });

      document.addEventListener('x-audio-player-play', function(e) {
            that.isPlaying = true;
      });

      document.addEventListener('x-audio-player-pause', function(e) {
          that.isPlaying = false;
      });

      },

      showFeedback: function() {
        window.location.href = "mailto:webmaster@library.uq.edu.au?subject=" + this.item.id;
      },

      backButtonHandler: function() {
        this.fire("back-button-clicked", { });
      },

      closeButtonHandler: function() {
        this.fire("close-button-clicked", { });
      },

      toggleAudioPlay: function(e, sender) {
        var _el = e.path[0];
        if(_el.icon == 'av:play-circle-outline') {
            _el.icon = 'av:pause-circle-outline';
            var _src = this.item.mp3;
            this.fire('x-audio-list-play', {src: _src, name: this.item.title_t});
        } else {
            _el.icon = 'close';
            this.fire('x-audio-list-pause');
        }

      },

    });
  })();
</script>
</polymer-element>
