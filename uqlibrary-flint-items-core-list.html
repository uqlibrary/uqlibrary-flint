<link rel="import" href="../uqlibrary-elements/0.5.4/lib/vulcanized-flint.html">

<polymer-element name="uqlibrary-flint-items-core-list" fit vertical layout>

<template>
  <link rel="stylesheet" href="../uqlibrary-elements/resources/theme/element.css">
  <uqlibrary-api-flint-records id="recordsApiElement"></uqlibrary-api-flint-records>

  <template if="{{showNoResults}}">
    <div class="text-container body1">
      TODO: update design/words/etc <br>
      No results found for search term "{{searchTerm}}", please, modify your search term and try again.
    </div>
  </template>

  <ul class="three-line-icon-list" flex>
    <core-list id="itemsList" on-core-activate="{{itemSelected}}" fit style="margin-bottom: 63px;">
      <template>

        <li class="list-item header border" divider horizontal layout center-center on-tap="{{keepItemDetailsOpen}}">

          <div class="avatar">
            <core-icon icon="hardware:headset" style="width: 32px; height: 32px;"></core-icon>
          </div>

          <div flex>{{groupModel.label}}</div>

          <div>
            <core-a11y-keys id="a11yCloseButton" keys="{{keyboardNavigationKeys}}"
                            on-keys-pressed="{{ closeButtonHandler }}"></core-a11y-keys>
            <paper-icon-button aria-label="Close panel" icon="close" id="closeButton" class="flint-responsive-menu-toggle-icon" on-click="{{closeButtonHandler}}"></paper-icon-button>
          </div>

        </li>


        <li class="list-item border listItem" data-index="{{index}}">

          <div class="avatar">
            <uqlibrary-a11y-link data-index="{{index}}" on-tap="{{ playRecord }}">
              <!-- TODO: replace MP3 with obj binding when available -->
              <paper-icon-button
                                class="audioControlButton"
                                role="button" aria-label="Play audio of {{model.title}}" data-index="{{index}}"
                                icon="av:play-circle-outline" data-title="{{model.title}}"
                                data-mp3="{{ index % 2 == 0 ? 'http://espace.library.uq.edu.au/view/UQ:318711/Reel35_PatBowe.mp3' : 'http://espace.library.uq.edu.au/view/UQ:318711/Reel36_PatBowe.mp3'}}"></paper-icon-button>

            </uqlibrary-a11y-link>
          </div>

          <div class="content" relative>

            <div class="line1" horizontal layout>
              <div flex class="line1">
                <uqlibrary-a11y-link data-index="{{index}}" on-tap="{{ itemSelectedKeyPressed }}">{{model.title}}</uqlibrary-a11y-link>
              </div>

              <div>
                <core-icon icon="chevron-right"></core-icon>
              </div>
            </div>

            <div class="line2">
              <template if={{voice}}>{{model.subject_lookups.subject_lookup}}</template>
              <template if={{searchTerm}}>{{model.subject_lookups.subject_lookup}}</template>
              <template if={{language}}>by {{model.contributors.contributor}}</template>
            </div>

            <div class="line3">
              <template if={{searchTerm}}>by {{model.contributors.contributor}}</template>
            </div>

          </div>
        </li>
      </template>
    </core-list>
  </ul>



  <div style="height: 65px;" relative>
    <div fit style="background-color: #efefef; border: 0px #999 solid; border-width: 0px 0 0 0; box-shadow: 6px 6px 6px 6px rgba(0, 0, 0, 0.37);">
      <x-audio id="audioPlayer" disabled showVolumeControls showName></x-audio>
    </div>
  </div>

</template>

<script>
  (function() {
    Polymer('uqlibrary-flint-items-core-list', {

      // Accessibility issues fixes
      keyboardNavigationKeys: 'space enter',

      ready: function() {
        // test MP3 files
        // "http://espace.library.uq.edu.au/view/UQ:318711/Reel35_PatBowe.mp3"
        // "http://espace.library.uq.edu.au/view/UQ:318711/Reel36_PatBowe.mp3"

        var that = this;

        this.previousPlayRecordButton = null;
        this.currentPlayRecordButton = null;

        this.language = null;
        this.voice = null;
        this.searchTerm = '';

        this.cacheData = {
          languages : {},
          voices: {}
        };


        this.$.recordsApiElement.addEventListener('uqlibrary-api-flint-records-loaded', function(e) {
          //Simulate different data
          e.detail.sort(function(a,b) {
            return (Math.random() < Math.random() ? -1 : 1)
          });

          that.showNoResults = that.searchTerm && e.detail && e.detail.length == 0;

          that.$.itemsList.data = e.detail;
          that.setPlayingRecord();
          that.$.itemsList.groups = [
            {
              length: e.detail.length,
              data: {
                label: that.language ? that.language.cvo_title : that.voice ? that.voice.cvo_title : "Search results for: " + that.searchTerm + " (" + e.detail.length + " items found) "
              }
            }
          ];

          //save data for this session - don't need to query api again for this language or voice
          if (that.language) {
            that.cacheData.languages[that.language.cvo_id] = e.detail;
          } else if (that.voice){
            that.cacheData.voices[that.voice.cvo_title] = e.detail;
          }
        });

        //setup audio player
        this.$.audioPlayer.addEventListener('x-audio-initialized', function() {
          that.$.audioPlayer.removeAttribute('disabled');
          that.$.audioPlayer.play();
        });

        this.$.audioPlayer.addEventListener('x-audio-play', function() {

          if(that.previousPlayRecordButton) {
            that.previousPlayRecordButton.icon = 'av:play-circle-outline';
          }

          if(that.currentPlayRecordButton) {
            that.currentPlayRecordButton.icon = 'av:pause-circle-outline';
          }

          that.previousPlayRecordButton = that.currentPlayRecordButton;
        });

        this.$.audioPlayer.addEventListener('x-audio-pause', function() {

          if(that.previousPlayRecordButton) {
            that.previousPlayRecordButton.icon = 'av:play-circle-outline';
          }

          if(that.currentPlayRecordButton) {
            that.currentPlayRecordButton.icon = 'av:play-circle-outline';
          }

          that.previousPlayRecordButton = that.currentPlayRecordButton;
        });
      },

      keepItemDetailsOpen: function(e, data, source) {
        this.skipItemSelected = true;
      },

      itemSelected: function(event, itemRow, list) {
        //do not close item details if user clicks on item details area
        if (this.skipItemSelected){
          this.skipItemSelected = false;
          return;
        }

        this.fire("item-selected", { item: itemRow.data });
      },

      itemSelectedKeyPressed: function(source) {
        if (source.path && source.path.length > 0 && (source.path[2].attributes["data-index"] || source.path[0].attributes["data-index"])) {
          this.skipItemSelected = false;

          var itemIndex = source.path[2].attributes["data-index"] ? source.path[2].attributes["data-index"].value : source.path[0].attributes["data-index"].value;
          this.itemSelected(null, { data: this.$.itemsList.data[itemIndex], item: source.path[4] }, null);
        }
      },

      playRecord: function(source) {
        var button = null;

        //event can be triggered by keyboard or mouse, process event for either
        if (source.path && source.path.length > 0 && source.path[0].tagName.toLowerCase() === "paper-icon-button") {
          //do not open/close item details on play/pause
          this.skipItemSelected = true;
          button = source.path[0];
        } else if (source.path && source.path.length > 0 && source.path[0].children
                && source.path[0].children[0].tagName.toLowerCase() === "paper-icon-button") {
          //do not open/close item details on play/pause
          this.skipItemSelected = true;
          button = source.path[0].children[0];
        }

        //setup audio player, play mp3 file
        this.currentPlayRecordButton = button;
        var audioFile = button.getAttribute("data-mp3");
        var audioFileName = button.getAttribute("data-title");

        if (this.$.audioPlayer.name === audioFileName && this.$.audioPlayer.src === audioFile) {
          this.$.audioPlayer.togglePlay();
        } else {
          this.$.audioPlayer.src = audioFile;
          this.$.audioPlayer.name = audioFileName;
        }
      },

      closeButtonHandler: function(e) {
        //do not open/close item details on close
        this.skipItemSelected = true;
        this.fire("close-button-clicked", { });
      },

      setData: function(args) {

        this.language = null;
        this.voice = null;
        this.searchTerm = '';

        var items = [];
        var listTitle = '';

        var that = this;

        if (args && args.language) {
          this.language = args.language;

          if (this.cacheData.languages[this.language.cvo_id]) {
            //get data from local cache
            items = this.cacheData.languages[this.language.cvo_id];
            this.$.itemsList.data = items;
            this.setPlayingRecord();
            this.$.itemsList.groups = [
              {
                length: items.length,
                data: {
                  label: this.language.cvo_title
                }
              }
            ];
          } else {
            //get data from search api
            this.$.recordsApiElement.get({ language: this.language.cvo_title });
          }
        } else if (args && args.voice) {
          this.voice = args.voice;
          listTitle = this.voice.cvo_title;

          if (this.cacheData.voices[this.voice.cvo_title]) {
            //get data from local cache
            items = this.cacheData.voices[this.voice.cvo_title];
            this.$.itemsList.data = items;
            this.setPlayingRecord();
            this.$.itemsList.groups = [
              {
                length: items.length,
                data: {
                  label: this.voice.cvo_title
                }
              }
            ];
          } else {
            //get data from search api
            this.$.recordsApiElement.get({ voice: this.voice.cvo_title });
          }
        } else if (args && args.searchTerm) {
          //get data from search api
          this.searchTerm = args.searchTerm;
          this.$.recordsApiElement.get({ keyword: this.searchTerm });
        }
      },

      setPlayingRecord: function() {
        if(this.$.itemsList.data) {
          var soundPlaying = null;
          var that = this;
          this.$.itemsList.data.forEach(function(item, index) {
            if(item.title == that.$.audioPlayer.name) {
              soundPlaying = index;
            }
          });

          var playButtons = this.$.itemsList.querySelectorAll('paper-icon-button.audioControlButton');
          for (var i = 0; i <	playButtons.length; i++) {
            if(i == soundPlaying) {
              playButtons[i].icon = 'av:pause-circle-outline';
            } else {
              playButtons[i].icon = 'av:play-circle-outline';
            }
          }

        }
      }
    });
  })();
</script>
</polymer-element>
