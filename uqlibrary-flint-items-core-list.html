<link rel="import" href="../uqlibrary-elements/0.5.4/lib/vulcanized-flint.html">

<polymer-element name="uqlibrary-flint-items-core-list" fit vertical layout>

<template>
  <link rel="stylesheet" href="../uqlibrary-elements/resources/theme/element.css">
  <uqlibrary-api-flint-records id="recordsApiElement"></uqlibrary-api-flint-records>

  <template if="{{showNoResults}}">
    <ul class="three-line-icon-list">
      <li class="list-item header border" horizontal layout center-center>

        <div class="avatar">
          <core-icon icon="hardware:headset" style="width: 32px; height: 32px;"></core-icon>
        </div>

        <div flex>Search results</div>
        <div>
          <core-a11y-keys target="{{$.closeNoResultsButton}}" keys="{{keyboardNavigationKeys}}"
                          on-keys-pressed="{{ closeButtonHandler }}"></core-a11y-keys>
          <paper-icon-button aria-label="Close panel" icon="close" id="closeNoResultsButton" class="flint-responsive-menu-toggle-icon" on-click="{{closeButtonHandler}}"></paper-icon-button>
        </div>
      </li>
      <li class="list-item">
        <div class="content">
          <div class="line3">
            0 items found for the search: '{{searchTerm}}'.
          </div>
          <div class="line3">
            Please, update your query and search again.
          </div>
        </div>
      </li>
    </ul>
  </template>


  <div id="audioPlayersHolder">
    <template repeat="{{item, index in $.itemsList.data}}">
      <x-audio hidden id="audio-{{index}}" name="{{item.title_t}}" src="{{ item.mp3 }}" ></x-audio>
    </template>
  </div>

  <template if="{{!showNoResults}}">
    <ul class="three-line-icon-list" flex>
      <core-list id="itemsList" on-core-activate="{{itemSelected}}" fit style="margin-bottom: 83px;">
      <template>

        <li class="list-item header border" divider horizontal layout center-center on-tap="{{keepItemDetailsOpen}}">

          <div class="avatar">
            <core-icon icon="hardware:headset" style="width: 32px; height: 32px;"></core-icon>
          </div>

          <div flex>{{groupModel.label}}</div>

          <div>
            <core-a11y-keys id="a11yCloseButton" keys="{{keyboardNavigationKeys}}"
                            on-keys-pressed="{{ closeButtonHandler }}"></core-a11y-keys>
            <paper-icon-button aria-label="Close panel" icon="close" id="closeButton" class="flint-responsive-menu-toggle-icon" on-click="{{closeButtonHandler}}"></paper-icon-button>
          </div>

        </li>


        <li class="list-item border listItem" data-index="{{index}}">

          <div class="avatar">
            <div class="audio-holder"></div>
          </div>

          <div class="content" relative>

            <div class="line1" horizontal layout>
              <div flex class="line1">
                <uqlibrary-a11y-link data-index="{{index}}" on-tap="{{ itemSelectedKeyPressed }}">{{model.title_t}}</uqlibrary-a11y-link>
              </div>

              <div>
                <core-icon icon="chevron-right"></core-icon>
              </div>
            </div>

            <div class="line2">
              <template if={{voice}}>{{model.subject_mi_lookup[0]}}</template>
              <template if={{searchTerm}}>{{model.subject_mi_lookup[0]}}</template>
              <template if={{language}}>by {{model.contributor_mt[0]}}</template>
            </div>

            <div class="line3">
              <template if={{searchTerm}}>by {{model.contributor_mt[0]}}</template>
            </div>

          </div>
        </li>
      </template>
    </core-list>
  </ul>
  </template>
</template>

<script>
  (function() {
    Polymer('uqlibrary-flint-items-core-list', {

      // Accessibility issues fixes
      keyboardNavigationKeys: 'space enter',

      ready: function() {
        // test MP3 files
        // "http://espace.library.uq.edu.au/view/UQ:318711/Reel35_PatBowe.mp3"
        // "http://espace.library.uq.edu.au/view/UQ:318711/Reel36_PatBowe.mp3"

        var that = this;

        this.previousPlayRecordButton = null;
        this.currentPlayRecordButton = null;

        this.language = null;
        this.voice = null;
        this.searchTerm = '';
        this.cacheData = {
          languages : {},
          voices: {}
        };
        this.currentRecordPlayingTitle = null,
        this.currentActivePlayer = null,
        this.activePlayer = null,



        this.$.recordsApiElement.addEventListener('uqlibrary-api-flint-records-loaded', function(e) {

          var data = e.detail;

          //Simulate different data for testing
          e.detail.sort(function(a,b) {
            return (Math.random() < Math.random() ? -1 : 1)
          });

          for(var i=0; i < e.detail.length; i++) {
            e.detail[i].mp3 = (Math.random() < Math.random() ? 'http://espace.library.uq.edu.au/view/UQ:318711/Reel35_PatBowe.mp3' : 'http://espace.library.uq.edu.au/view/UQ:318711/Reel36_PatBowe.mp3')
          }

          var randomData = e.detail.slice(0, Math.floor((Math.random() * e.detail.length) + 1));
          data = randomData; // TODO: remove simulating for real data

          that.showNoResults = that.searchTerm && e.detail && e.detail.length == 0;
          that.$.itemsList.data = data;
          that.setAudioRecords();
          that.$.itemsList.groups = [
            {
              length: data.length,
              data: {
                label: that.language ? that.language.cvo_title : that.voice ? that.voice.cvo_title : "Search results for: " + that.searchTerm + " (" + data.length + " items found) "
              }
            }
          ];

          //save data for this session - don't need to query api again for this language or voice
          if (that.language) {
            that.cacheData.languages[that.language.cvo_id] = data;
          } else if (that.voice){
            that.cacheData.voices[that.voice.cvo_title] = data;
          }
        });


        this.addEventListener('x-audio-play', function(e) {
          that.currentRecordPlayingTitle = e.path[0].name;
        });

      },

      keepItemDetailsOpen: function(e, data, source) {
        this.skipItemSelected = true;
      },

      itemSelected: function(event, itemRow, list) {
        //do not close item details if user clicks on item details area
        if (this.skipItemSelected){
          this.skipItemSelected = false;
          return;
        }

        this.fire("item-selected", { item: itemRow.data });
      },

      itemSelectedKeyPressed: function(source) {
        if (source.path && source.path.length > 0 && (source.path[2].attributes["data-index"] || source.path[0].attributes["data-index"])) {
          this.skipItemSelected = false;

          var itemIndex = source.path[2].attributes["data-index"] ? source.path[2].attributes["data-index"].value : source.path[0].attributes["data-index"].value;
          this.itemSelected(null, { data: this.$.itemsList.data[itemIndex], item: source.path[4] }, null);
        }
      },

     /* playRecord: function(source) {
        var button = null;

        //event can be triggered by keyboard or mouse, process event for either
        if (source.path && source.path.length > 0 && source.path[0].tagName.toLowerCase() === "paper-icon-button") {
          //do not open/close item details on play/pause
          this.skipItemSelected = true;
          button = source.path[0];
        } else if (source.path && source.path.length > 0 && source.path[0].children
                && source.path[0].children[0].tagName.toLowerCase() === "paper-icon-button") {
          //do not open/close item details on play/pause
          this.skipItemSelected = true;
          button = source.path[0].children[0];
        }

        //setup audio player, play mp3 file
        this.currentPlayRecordButton = button;
        var audioFile = button.getAttribute("data-mp3");
        var audioFileName = button.getAttribute("data-title");

        if (this.$.audioPlayerMirror.xaudio === audioFileName && this.$.audioPlayer.src === audioFile) {
          this.$.audioPlayer.togglePlay();
        } else {
          this.$.audioPlayer.src = audioFile;
          this.$.audioPlayer.name = audioFileName;
        }
      },*/

      closeButtonHandler: function(e) {
        //do not open/close item details on close
        this.skipItemSelected = true;
        this.fire("close-button-clicked", { });
      },

      setData: function(args) {

        this.language = null;
        this.voice = null;
        this.searchTerm = '';

        var items = [];
        var listTitle = '';

        var that = this;

        if (args && args.language) {
          this.language = args.language;

          if (this.cacheData.languages[this.language.cvo_id]) {
            //get data from local cache
            items = this.cacheData.languages[this.language.cvo_id];
            this.$.itemsList.data = items;
            this.setAudioRecords();
            this.$.itemsList.groups = [
              {
                length: items.length,
                data: {
                  label: this.language.cvo_title
                }
              }
            ];
          } else {
            //get data from search api
            this.$.recordsApiElement.get({ language: this.language.cvo_title });
          }
        } else if (args && args.voice) {
          this.voice = args.voice;
          listTitle = this.voice.cvo_title;

          if (this.cacheData.voices[this.voice.cvo_title]) {
            //get data from local cache
            items = this.cacheData.voices[this.voice.cvo_title];
            this.$.itemsList.data = items;
            this.setAudioRecords();
            this.$.itemsList.groups = [
              {
                length: items.length,
                data: {
                  label: this.voice.cvo_title
                }
              }
            ];
          } else {
            //get data from search api
            this.$.recordsApiElement.get({ voice: this.voice.cvo_title });
          }
        } else if (args && args.searchTerm) {
          //get data from search api
          this.searchTerm = args.searchTerm;
          this.$.recordsApiElement.get({ keyword: this.searchTerm });
        }
      },


      // This is necessary because core list doesn't work properly with x-audio elements
      setAudioRecords: function() {
        if(this.$.itemsList.data) {
          var that = this;
          setTimeout(function() {
            var audioPLayers = that.$.audioPlayersHolder.querySelectorAll('x-audio');
            var listItems = that.$.itemsList.querySelectorAll('.audio-holder');
              if (listItems.length > 0) {
                  for (var i = 0; i <	audioPLayers.length; i++) {
                      while (listItems[i].firstChild) {
                          listItems[i].removeChild(listItems[i].firstChild);
                      }
                      audioPLayers[i].hidden = false;
                      listItems[i].appendChild(audioPLayers[i]);
                  }
              }
          }, 0);

        }
      }
    });
  })();
</script>
</polymer-element>
