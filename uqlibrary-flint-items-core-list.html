<link rel="import" href="../uqlibrary-elements/0.5.4/lib/vulcanized-flint.html">

<polymer-element name="uqlibrary-flint-items-core-list" fit vertical layout>

<template>
  <link rel="stylesheet" href="../uqlibrary-elements/resources/theme/element.css">
  <uqlibrary-api-flint-records id="recordsApiElement"></uqlibrary-api-flint-records>

  <style>

    .three-line-icon-list .list-item.expanded {
      height: 560px !important;
    }

  </style>

  <ul class="three-line-icon-list" flex>

    <core-list id="itemsList" on-core-activate="{{itemSelected}}" fit style="margin-bottom: 63px;">
      <template>

        <li class="list-item header" divider horizontal layout center-center>

          <div class="avatar">
            <core-icon icon="hardware:headset" style="width: 32px; height: 32px;"></core-icon>
          </div>

          <div flex>{{groupModel.label}}</div>

          <div>
            <paper-icon-button aria-label="Close panel" icon="close" id="closeButton" class="flint-responsive-menu-toggle-icon" on-click="{{closeButtonHandler}}"></paper-icon-button>
          </div>

        </li>

        <li class="list-item border" data-index="{{index}}">

          <div class="avatar">
            <uqlibrary-a11y-link data-index="{{index}}" on-tap="{{ playRecord }}">
              <!-- TODO: replace MP3 with obj binding when available -->
              <core-icon-button aria-label="Play audio of {{model.title}}" data-index="{{index}}"
                                icon="av:play-circle-outline" data-title="{{model.title}}"
                                data-mp3="{{ index % 2 == 0 ? 'http://espace.library.uq.edu.au/view/UQ:318711/Reel35_PatBowe.mp3' : 'http://espace.library.uq.edu.au/view/UQ:318711/Reel36_PatBowe.mp3'}}"></core-icon-button>
            </uqlibrary-a11y-link>
          </div>

          <div class="content" relative>

            <paper-ripple fit></paper-ripple>

            <div class="line1" horizontal layout>
              <div flex class="line1">
                <uqlibrary-a11y-link data-index="{{index}}" on-tap="{{ itemSelectedKeyPressed }}">{{model.title}}</uqlibrary-a11y-link>
              </div>

              <div>
                <core-icon icon="expand-more" hidden?="{{model.showMore}}"></core-icon>
                <core-icon icon="expand-less" hidden?="{{!model.showMore}}"></core-icon>
              </div>
            </div>

            <div class="line2" hidden?="{{model.showMore}}">
              <template if={{voice}}>{{model.subjects.subject}}</template>
              <template if={{searchTerm}}>{{model.subjects.subject}}</template>
              <template if={{language}}>by {{model.contributors.contributor}}</template>
            </div>

            <div class="line3" hidden?="{{model.showMore}}">
              <template if={{searchTerm}}>by {{model.contributors.contributor}}</template>
            </div>

          </div>

          <core-collapse id="itemDetailsCollapse" data-index="{{index}}">
              <uqlibrary-flint-item item="{{model}}" on-tap="{{keepItemDetailsOpen}}" hidden?="{{!model.showMore}}"></uqlibrary-flint-item>
          </core-collapse>

        </li>
      </template>
    </core-list>
  </ul>

  <div style="height: 65px;" relative>
    <div fit style="background-color: #efefef; border: 0px #999 solid; border-width: 0px 0 0 0; box-shadow: 6px 6px 6px 6px rgba(0, 0, 0, 0.37);">
      <x-audio id="audioPlayer" showVolumeControls showName></x-audio>
    </div>
  </div>

</template>

<script>
  (function() {
    Polymer('uqlibrary-flint-items-core-list', {

      ready: function() {
        // test MP3 files
        // "http://espace.library.uq.edu.au/view/UQ:318711/Reel35_PatBowe.mp3"
        // "http://espace.library.uq.edu.au/view/UQ:318711/Reel36_PatBowe.mp3"

        var that = this;

        this.previousPlayRecordButton = null;
        this.currentPlayRecordButton = null;

        this.language = null;
        this.voice = null;
        this.searchTerm = '';

        this.cacheData = {
          languages : {},
          voices: {}
        };

        this.$.recordsApiElement.addEventListener('uqlibrary-api-flint-records-loaded', function(e) {

          that.$.itemsList.data = e.detail;
          that.$.itemsList.groups = [
            {
              length: e.detail.length,
              data: {
                label: that.language ? that.language.cvo_title : that.voice ? that.voice.cvo_title : that.searchTerm
              }
            }
          ];

          //save data for this session - don't need to query api again for this language or voice
          if (that.language) {
            that.cacheData.languages[that.language.cvo_id] = e.detail;
          } else if (that.voice){
            that.cacheData.voices[that.voice.cvo_title] = e.detail;
          }
        });

        //setup audio player
        this.$.audioPlayer.addEventListener('x-audio-initialized', function() {
          console.log("x-audio-initialized");

          that.$.audioPlayer.play();
        });

        this.$.audioPlayer.addEventListener('x-audio-play', function() {
          console.log("x-audio-play");

          if(that.previousPlayRecordButton) {
            that.previousPlayRecordButton.icon = 'av:play-circle-outline';
          }

          if(that.currentPlayRecordButton) {
            that.currentPlayRecordButton.icon = 'av:pause-circle-outline';
          }

          that.previousPlayRecordButton = that.currentPlayRecordButton;
        });

        this.$.audioPlayer.addEventListener('x-audio-pause', function() {
          console.log("x-audio-pause");

          if(that.previousPlayRecordButton) {
            that.previousPlayRecordButton.icon = 'av:play-circle-outline';
          }

          if(that.currentPlayRecordButton) {
            that.currentPlayRecordButton.icon = 'av:play-circle-outline';
          }

          that.previousPlayRecordButton = that.currentPlayRecordButton;
        });
      },

      keepItemDetailsOpen: function(e, data, source) {
        this.skipItemSelected = true;
      },

      itemSelected: function(event, itemRow, list) {
        //do not close item details if user clicks on item details area
        if (this.skipItemSelected){
          this.skipItemSelected = false;
          return;
        }

        var collapseSection = itemRow.item.querySelector("#itemDetailsCollapse");
        if (!collapseSection.opened) {
          itemRow.item.setAttribute("class", "list-item border expanded");
          itemRow.data.showMore = true;
        } else {
          itemRow.item.setAttribute("class", "list-item border");
          itemRow.data.showMore = false;
        }

        collapseSection.toggle();
        this.$.itemsList.updateSize();
      },

      itemSelectedKeyPressed: function(source) {
        if (source.path && source.path.length > 0 && source.path[0].attributes["data-index"]) {
          this.skipItemSelected = false;

          var itemIndex = source.path[0].attributes["data-index"].value;
          this.itemSelected(null, { data: this.$.itemsList.data[itemIndex], item: source.path[3] }, null);
        }
      },

      playRecord: function(source) {
        var button = null;

        //event can be triggered by keyboard or mouse, process event for either
        if (source.path && source.path.length > 0 && source.path[0].tagName.toLowerCase() === "core-icon-button") {
          //do not open/close item details on play/pause
          this.skipItemSelected = true;
          button = source.path[0];
        } else if (source.path && source.path.length > 0 && source.path[0].children
                && source.path[0].children[0].tagName.toLowerCase() === "core-icon-button") {
          //do not open/close item details on play/pause
          this.skipItemSelected = true;
          button = source.path[0].children[0];
        }

        //setup audio player, play mp3 file
        this.currentPlayRecordButton = button;
        var audioFile = button.getAttribute("data-mp3");
        var audioFileName = button.getAttribute("data-title");

        console.log("playRecord: " + audioFileName);

        if (this.$.audioPlayer.name === audioFileName && this.$.audioPlayer.src === audioFile) {
          this.$.audioPlayer.togglePlay();
        } else {
          this.$.audioPlayer.src = audioFile;
          this.$.audioPlayer.name = audioFileName;
        }
      },

      closeButtonHandler: function(e) {
        //do not open/close item details on close
        this.skipItemSelected = true;
        this.fire("close-button-clicked", { });
      },

      setData: function(args) {

        this.language = null;
        this.voice = null;
        this.searchTerm = '';

        var items = [];
        var listTitle = '';

        if (args && args.language) {
          this.language = args.language;

          if (this.cacheData.languages[this.language.cvo_id]) {
            //get data from local cache
            items = this.cacheData.languages[this.language.cvo_id];
            this.$.itemsList.data = items;
            this.$.itemsList.groups = [
              {
                length: items.length,
                data: {
                  label: this.language.cvo_title
                }
              }
            ];
          } else {
            //get data from search api
            this.$.recordsApiElement.get({ language: this.language.cvo_title });
          }
        } else if (args && args.voice) {
          this.voice = args.voice;
          listTitle = this.voice.cvo_title;

          if (this.cacheData.voices[this.voice.cvo_title]) {
            //get data from local cache
            items = this.cacheData.voices[this.voice.cvo_title];
            this.$.itemsList.data = items;
            this.$.itemsList.groups = [
              {
                length: items.length,
                data: {
                  label: this.voice.cvo_title
                }
              }
            ];
          } else {
            //get data from search api
            this.$.recordsApiElement.get({ voice: this.voice.cvo_title });
          }
        } else if (args && args.searchTerm) {
          //get data from search api
          this.searchTerm = args.searchTerm;
          this.$.recordsApiElement.get({ keyword: this.searchTerm });
        }
      }
    });
  })();
</script>
</polymer-element>
