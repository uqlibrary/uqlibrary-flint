<link rel="import" href="../uqlibrary-elements/0.5.4/lib/vulcanized-flint.html">
<link rel="import" href="uqlibrary-flint-items-core-list.html">
<link rel="import" href="uqlibrary-flint-categories-list.html">
<link rel="import" href="uqlibrary-flint-item.html">
<link rel="import" href="uqlibrary-flint-google-map.html">
<link rel="import" href="uqlibrary-flint-warning-dialog.html">
<link rel="import" href="core-collapse.html">

<polymer-element name="uqlibrary-flint">

  <template>
    <link rel="stylesheet" href="../uqlibrary-elements/resources/theme/element.css" shim-shadowdom>

    <uqlibrary-ga id="ga" appName="FlintCollection"></uqlibrary-ga>

    <core-drawer-panel id="outerDrawerPanel" responsiveWidth="768px">
      <div drawer class="left-drawer">
        <uqlibrary-menu menuFile="flint.json" on-uqlibrary-menu-link-clicked="{{menuLinkClicked}}"></uqlibrary-menu>
      </div>
      <div main layout vertical class="main">
        <uqlibrary-toolbar id="toolbar"
                           on-uqlibrary-toolbar-menu-clicked="{{toggleMenuDrawer}}"
                           on-uqlibrary-toolbar-search-submitted="{{performSearch}}"
                           appTitle="Indigenous Voices of Queensland"
                           appTitleLink="#"
                           appLinks=""
                           searchPlaceholderText="Search Indigenous Voices by keywords">
        </uqlibrary-toolbar>

        <core-drawer-panel id="innerDrawerPanel" main rightDrawer responsiveWidth="768px" drawerWidth="300px"
                         disableSwipe style="margin-top: 64px;">


        <div id="itemDetailDrawer" drawer class="right-drawer">

          <core-animated-pages selected="{{currentDrawerSection}}" valueattr="data-selected-section"
                               transitions="slide-from-right" id="animatedDrawerPages">
            <section id="infoSection" data-selected-section="infoSection">


              <ul class="three-line-icon-list">
                <li class="list-item header border" horizontal layout center-center>

                  <div class="avatar">
                    <core-icon icon="info" aria-label="information about this application"></core-icon>
                  </div>

                  <div flex>About this collection</div>
                  <div>
                    <core-a11y-keys target="{{$.closeNoResultsButton}}" keys="{{keyboardNavigationKeys}}"
                                    on-keys-pressed="{{ closeButtonHandler }}"></core-a11y-keys>
                    <paper-icon-button aria-label="Close panel" icon="close" id="closeButton" class="flint-responsive-menu-toggle-icon" on-click="{{toggleItemDetailsDrawer}}"></paper-icon-button>
                  </div>
                </li>
                <li class="list-item">

                  <div class="content">
                  <div class="subhead" on-tap="{{toggle}}">
                    <core-icon icon="expand-more"></core-icon> What is the Indigenous Voices of Queensland website?
                    <core-collapse opened>
                      <div class="line2">
                        Indigenous voices makes available rare, archival recordings of Indigenous languages. The project has digitised, identified, and consulted with Indigenous communities to ensure access for:
                        <ul>
                          <li>Indigenous community members</li>
                          <li>descendants of those whose languages were recorded</li>
                          <li>students</li>
                          <li>researchers</li>
                          <li>the public.</li>
                        </ul>
                      </div>
                    </core-collapse>
                  </div>
                    </div>

                  <div class="content">
                  <div class="subhead" on-tap="{{toggle}}">
                    <core-icon icon="chevron-right"></core-icon> Why were the languages recorded?
                  <core-collapse>
                    <div class="line2">
                        The languages were recorded in the 1960s as part of the Queensland Speech Survey conducted by Elwyn Flint of the University of Queensland English Department. The survey included recording varieties of English spoken throughout Queensland, including varieties of English spoken in Aboriginal reserves and missions.  While Flint and his assistants visited these reserves and missions, they also were able to record samples of some of the traditional Indigenous languages spoken by people living there at the time.  The Queensland Speech Survey thus includes one of the largest and broadest collection of recordings of Indigenous languages spoken in Queensland in the 20th century.
                    </div>
                  </core-collapse>
                  </div>
                    </div>

                  <div class="content">
                  <div class="subhead" on-tap="{{toggle}}">
                    <core-icon icon="chevron-right"></core-icon> About Queensland Indigenous Languages
                    <core-collapse>
                      <div class="line2">
                        Flintâ€™s recordings were made of people who were living on reserves and missions, mostly in the North of the State, including some Torres Strait Islands. He also visited Woorabinda in Central Queensland and Cherbourg in South-East Queensland. He was not attempting a comprehensive survey of all Queensland Indigenous languages still spoken.
                      </div>
                    </core-collapse>
                  </div>
                    </div>

              </ul>

            </section>
            <section id="itemsListSection" data-selected-section="itemsListSection">
              <uqlibrary-flint-items-core-list id="itemsListElement"
                                               on-close-button-clicked="{{toggleItemDetailsDrawer}}"
                                               on-item-selected="{{displayItemDetails}}"
                                               on-play-record-clicked="{{playRecord}}"></uqlibrary-flint-items-core-list>
            </section>
            <section id="itemSection" data-selected-section="itemSection">
              <uqlibrary-flint-item id="itemElement"
                                    on-close-button-clicked="{{toggleItemDetailsDrawer}}"
                                    on-back-button-clicked="{{displayListSection}}"></uqlibrary-flint-item>
            </section>
          </core-animated-pages>

          <div id="activePlayerWrapper" hidden?="{{$.audioPlayer.src == ''}}">
            <div layout vertical fit>

              <div>
                <x-audio id="audioPlayer" disabled showVolumeControls?="{{!isIOS}}" showSeekControl></x-audio>
              </div>
              <div class="currentlyPlayingTitle">
                Currently playing: {{$.audioPlayer.name || '--'}}
              </div>
            </div>
          </div>

        </div>
        <div main layout vertical relative class="main">

          <div id="headerPlayerMirrorWrapper" class="{{isIOS ? 'ios' : ''}}" hidden?="{{$.audioPlayer.src == '' || !$.innerDrawerPanel.narrow || searchActivated}}">
            <x-audio-mirror id="headerPlayerMirror" showVolumeControls?="{{!isIOS}}"></x-audio-mirror>
          </div>

          <paper-tabs selected="{{currentSection}}" valueattr="data-selected-section">
            <paper-tab data-selected-section="mapSection" id="mapSection" on-tap="{{centerMapIfSelected}}">
              <uqlibrary-a11y-link>Map</uqlibrary-a11y-link>
            </paper-tab>
            <paper-tab data-selected-section="languageSection">
              <uqlibrary-a11y-link>Languages</uqlibrary-a11y-link>
            </paper-tab>
            <paper-tab data-selected-section="voicesSection">
              <uqlibrary-a11y-link>Voices</uqlibrary-a11y-link></paper-tab>
          </paper-tabs>

          <core-animated-pages selected="{{currentSection}}" valueattr="data-selected-section"
                               transitions="slide-from-right" flex id="animatedPages">
            <section id="mapDisplaySection" data-selected-section="mapSection">
              <uqlibrary-flint-categories-list id="mapList" showMap="true" on-category-selected="{{categorySelected}}"></uqlibrary-flint-categories-list>
            </section>
            <section id="languageListSection" data-selected-section="languageSection">
              <uqlibrary-flint-categories-list id="languagesList" on-category-selected="{{categorySelected}}"></uqlibrary-flint-categories-list>
            </section>
            <section id="voiceListSection" data-selected-section="voicesSection">
              <uqlibrary-flint-categories-list id="voicesList" on-category-selected="{{categorySelected}}"></uqlibrary-flint-categories-list>
            </section>
          </core-animated-pages>

        </div>
      </core-drawer-panel>

      </div>
    </core-drawer-panel>

    <uqlibrary-flint-warning-dialog autoOpen
                                    cancelRedirectUrl="https://www.library.uq.edu.au/fryer-library/"></uqlibrary-flint-warning-dialog>

  </template>

  <script>
    (function () {
      Polymer('uqlibrary-flint', {

        // Accessibility issues fixes
        keyboardNavigationKeys: 'space enter',
        a11yKeyPressed: function (source, event) {
          if (source.path && source.path.length > 0 && source.path[0].target) {
            source.path[0].target.fire("tap");
          }
        },
        activePlayer: null,
        activeAudioSrc: null,
        activeAudioMirror: null,
        searchActivated: false,
        isIOS: false,

        ready: function () {
          var that = this;
          var toolbarHeight = this.$.toolbar.clientHeight;
          var playerHeight = this.$.activePlayerWrapper.clientHeight;
          var listHeight = window.innerHeight - toolbarHeight - playerHeight;
          var innerPanelHeight = window.innerHeight - toolbarHeight;

          this.isIOS = navigator.userAgent.match(/iP(?:hone|ad;(?: U;)? CPU) OS (\d+)/);
          that.$.animatedDrawerPages.setAttribute('style', 'overflow-x: hidden; overflow-y: auto; height: ' + innerPanelHeight + 'px');
          that.$.itemsListSection.setAttribute('style', 'height: ' + listHeight + 'px');
          that.$.innerDrawerPanel.setAttribute('style', 'margin-top:64px; height: ' + innerPanelHeight + 'px');

          window.addEventListener('resize', function() {
            listHeight = window.innerHeight - toolbarHeight - playerHeight;
            innerPanelHeight = window.innerHeight - toolbarHeight;

            that.$.animatedDrawerPages.setAttribute('style', 'overflow-x: hidden; overflow-y: auto; height: ' + innerPanelHeight + 'px');
            that.$.itemsListSection.setAttribute('style', 'height: ' + listHeight + 'px');
            that.$.innerDrawerPanel.setAttribute('style', 'margin-top:64px; height: ' + innerPanelHeight + 'px');

            var responsiveWidth = parseInt(that.$.innerDrawerPanel.responsiveWidth);

            if (responsiveWidth > window.innerWidth) {
              that.$.innerDrawerPanel.drawerWidth = "95%";
            } else if (responsiveWidth <= window.innerWidth) {
              that.$.innerDrawerPanel.drawerWidth = "50%";
            }
          });

          var responsiveWidth = parseInt(this.$.innerDrawerPanel.responsiveWidth);

          if (responsiveWidth > window.innerWidth) {
            this.$.innerDrawerPanel.drawerWidth = "95%";
          } else if (responsiveWidth <= window.innerWidth) {
            this.$.innerDrawerPanel.drawerWidth = "50%";
          }

          this.currentSection = "mapSection";

          // Fix Google map bug when window is resized and map is hidden
          this.$.animatedPages.addEventListener('core-animated-pages-transition-end', function() {
            if (that.currentSection == "mapSection") {
              that.$.mapList.resizeMap();
            }
          });

          document.addEventListener('x-audio-initialized', function(e, source) {
            that.$.audioPlayer.disabled = false;
            that.$.headerPlayerMirror.xaudio = that.$.audioPlayer;
            that.activeAudioSrc = that.$.audioPlayer.src;
            that.$.audioPlayer.play();
            that.activePlayer = that.$.audioPlayer;

          });

          document.addEventListener('x-audio-list-pause', function(e) {

            that.$.audioPlayer.pause();
          });

          document.addEventListener('x-audio-list-play', function(e, source) {
            if(that.activeAudioSrc && (that.activeAudioSrc != e.detail.src) || that.activeAudioSrc == null)  {
              if(that.$.audioPlayer.src) {
                that.$.audioPlayer.pause();
              }
              that.$.audioPlayer.setSrc(e.detail.src);
              that.$.audioPlayer.name = e.detail.name;
            }
            else {
              that.$.audioPlayer.play();
            }

            if( that.activeAudioMirror != null) {
              that.activeAudioMirror.togglePlay();
            }
          });

          document.addEventListener('x-audio-play', function(e) {
            that.fire('x-audio-player-play', {audio: that.$.audioPlayer.audio});
          });

          document.addEventListener('x-audio-pause', function(e) {
            that.fire('x-audio-player-pause', {audio: that.$.audioPlayer.audio});
          });

          document.addEventListener('uqlibrary-flint-request-current-audio', function(e) {
            that.fire('uqlibrary-flint-response-current-audio', {audio: that.$.audioPlayer.audio, isPlaying: that.$.audioPlayer.isPlaying})
          });


        },

        // toggles core-collapse and updates icon for infoSection stuff
        toggle: function(sender) {
          if (sender.target.nodeName == "CORE-ICON") {
            if (sender.target.parentNode.querySelector('core-collapse').classList == "core-collapse-closed") {
              sender.target.querySelector('core-icon').icon = "expand-more";
            } else if (sender.target.parentNode.querySelector('core-collapse').classList != "core-collapse-closed") {
              sender.target.querySelector('core-icon').icon = "chevron-right";
            }
            sender.target.parentNode.querySelector('core-collapse').toggle();
          } else {
            if (sender.target.querySelector('core-collapse').classList == "core-collapse-closed") {
              sender.target.querySelector('core-icon').icon = "expand-more";
            } else if (sender.target.querySelector('core-collapse').classList != "core-collapse-closed") {
              sender.target.querySelector('core-icon').icon = "chevron-right";
            }
            sender.target.querySelector('core-collapse').toggle();
          }

        },

        centerMapIfSelected: function () {
          if (this.currentSection === "mapSection") {
            this.fire('uqlibrary-flint-map-center-tap');
          }
        },

        toggleItemDetailsDrawer: function () {
          this.$.innerDrawerPanel.togglePanel();
        },

        toggleMenuDrawer: function () {
          this.$.outerDrawerPanel.togglePanel();
        },

        performSearch: function(e) {
          if (e.detail.searchTerm != "") {
            this.$.itemsListElement.setData( { searchTerm: e.detail.searchTerm });
            this.currentDrawerSection = 'itemsListSection';
            this.toggleItemDetailsDrawer();
          }
        },

        currentSectionChanged : function(oldValue, newValue){

          switch(this.currentSection) {
            case "languageSection":
              //setup languages list
              this.$.languagesList.setData({ displayLanguages: true });
              break;
            case "voicesSection":
              //setup voices list
              this.$.voicesList.setData({ displayVoices: true });
              break;
            case "mapSection":
              //setup map
              this.$.mapList.setData({ displayLanguages: true });
              break;
          }
        },

        categorySelected: function(e) {
          switch(this.currentSection) {
            case "mapSection":
              this.$.itemsListElement.setData( { language: e.detail });
              this.toggleItemDetailsDrawer();
              break;
            case "languageSection":
              this.$.itemsListElement.setData( { language: e.detail });
              this.toggleItemDetailsDrawer();
              break;
            case "voicesSection":
              this.$.itemsListElement.setData( { voice: e.detail });
              this.toggleItemDetailsDrawer();
              break;
          }

          this.currentDrawerSection = 'itemsListSection';
        },

        displayItemDetails: function(e) {
          this.currentDrawerSection = 'itemSection';
          this.$.itemElement.item = e.detail.item;
          this.fire('uqlibrary-flint-request-current-audio');
        },

        displayListSection: function(e) {
          this.currentDrawerSection = 'itemsListSection';
          this.fire('uqlibrary-flint-request-current-audio');
        },

        menuLinkClicked: function(e) {
          switch(e.detail) {
            case "#about":
              this.currentDrawerSection = 'infoSection';

              this.toggleMenuDrawer();
              this.toggleItemDetailsDrawer();
              break;
          }
        }
      })
    })();
  </script>

</polymer-element>