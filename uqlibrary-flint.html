<link rel="import" href="../uqlibrary-elements/0.5.4/lib/vulcanized-flint.html">
<link rel="import" href="uqlibrary-flint-items-core-list.html">
<link rel="import" href="uqlibrary-flint-categories-list.html">
<link rel="import" href="uqlibrary-flint-item.html">
<link rel="import" href="uqlibrary-flint-warning-dialog.html">

<polymer-element name="uqlibrary-flint">

  <template>
    <link rel="stylesheet" href="../uqlibrary-elements/resources/theme/element.css" shim-shadowdom>

    <uqlibrary-ga id="ga" appName="FlintCollection"></uqlibrary-ga>

    <core-drawer-panel id="outerDrawerPanel" responsiveWidth="1500px">
      <div drawer class="left-drawer">
        <uqlibrary-menu menuFile="flint.json"></uqlibrary-menu>
      </div>

      <core-drawer-panel id="innerDrawerPanel" main rightDrawer responsiveWidth="750px" drawerWidth="360px"
                         disableSwipe>
        <div id="itemDetailDrawer" drawer class="right-drawer">
          <uqlibrary-flint-items-core-list id="itemsListElement"
                                           on-close-button-clicked="{{toggleItemDetailsDrawer}}"
                                           on-play-record-clicked="{{playRecord}}"></uqlibrary-flint-items-core-list>
        </div>
        <div main layout vertical relative>
          <core-toolbar>
            <paper-icon-button icon="menu" class="flint-responsive-menu-icon"
                               on-click="{{toggleMenuDrawer}}"></paper-icon-button>
            <div class="glow">
              <h1 flex id="toolbar-page-title">Indigenous Voices</h1>
            </div>
          </core-toolbar>

          <paper-tabs selected="{{currentSection}}" valueattr="data-selected-section">
            <paper-tab data-selected-section="mapSection">
              <uqlibrary-a11y-link>Map</uqlibrary-a11y-link>
            </paper-tab>
            <paper-tab data-selected-section="languageSection">
              <uqlibrary-a11y-link>Languages</uqlibrary-a11y-link>
            </paper-tab>
            <paper-tab data-selected-section="voicesSection">
              <uqlibrary-a11y-link>Voices</uqlibrary-a11y-link></paper-tab>
            <paper-tab data-selected-section="searchSection">
              <uqlibrary-a11y-link>Search</uqlibrary-a11y-link></paper-tab>
          </paper-tabs>

          <core-animated-pages selected="{{currentSection}}" valueattr="data-selected-section"
                               transitions="slide-from-right" flex>
            <section id="mapDisplaySection" data-selected-section="mapSection">

              <!--<google-map latitude="-21.488403" longitude="147.1480151" disableDefaultUI zoom="6">-->

              <!--<google-map-marker latitude="-19.265433" longitude="146.816289" clickEvents></google-map-marker>-->
              <!--<google-map-marker latitude="-21.392335" longitude="145.101973" clickEvents></google-map-marker>-->

              <!--</google-map>-->

              <div vertical layout>
                <div class="responsiveCard">

                  <div class="subhead cardSection cardTitle">
                    TODO: Uncomment the google map component here once it has been imported through uqlibrary-elements
                  </div>

                  <a href="#" on-click="{{toggleItemDetailsDrawer}}">Open drawer</a>

                  <x-audio id="audioPlayer" showVolumeControls showName></x-audio>

                </div>
              </div>
            </section>
            <section id="languageListSection" data-selected-section="languageSection">
              <uqlibrary-flint-categories-list id="languagesList" on-category-selected="{{categorySelected}}"></uqlibrary-flint-categories-list>
            </section>
            <section id="voiceListSection" data-selected-section="voicesSection">
              <uqlibrary-flint-categories-list id="voicesList" on-category-selected="{{categorySelected}}"></uqlibrary-flint-categories-list>
            </section>
            <section id="searchSection" data-selected-section="searchSection">

              <uqlibrary-flint-items-core-list id="searchResultsListElement"
                                               on-play-record-clicked="{{playRecord}}"></uqlibrary-flint-items-core-list>

              <!--<div vertical layout>-->
                <!--<div class="responsiveCard">-->
                  <!--<div class="subhead cardSection cardTitle">TODO: Add Search Tab stuff</div>-->
                  <!--search results list goes here...<br/>-->
                  <!--search results list goes here...<br/>-->
                  <!--search results list goes here...<br/>-->
                  <!--search results list goes here...<br/>-->
                  <!--search results list goes here...<br/>-->
                <!--</div>-->
              <!--</div>-->
            </section>
          </core-animated-pages>

        </div>
      </core-drawer-panel>

    </core-drawer-panel>

    <uqlibrary-flint-warning-dialog autoOpen
                                    cancelRedirectUrl="https://www.library.uq.edu.au/fryer-library/"></uqlibrary-flint-warning-dialog>

  </template>

  <script>

    (function () {
      Polymer('uqlibrary-flint', {

        // Accessibility issues fixes
        keyboardNavigationKeys: 'space enter',
        a11yKeyPressed: function (source, event) {
          if (source.path && source.path.length > 0 && source.path[0].target) {
            source.path[0].target.fire("tap");
          }
        },

        ready: function () {
          var that = this;

          this.previousPlayRecordButton = null;
          this.currentPlayRecordButton = null;

          //setup audio player
          this.$.audioPlayer.addEventListener('x-audio-initialized', function() {
            console.log("x-audio-initialized");

            that.$.audioPlayer.play();
          });

          this.$.audioPlayer.addEventListener('x-audio-play', function() {
            console.log("x-audio-play");

            if(that.previousPlayRecordButton) {
              that.previousPlayRecordButton.icon = 'av:play-circle-outline';
            }

            if(that.currentPlayRecordButton) {
              that.currentPlayRecordButton.icon = 'av:pause-circle-outline';
            }

            that.previousPlayRecordButton = that.currentPlayRecordButton;
          });

          this.$.audioPlayer.addEventListener('x-audio-pause', function() {
            console.log("x-audio-pause");

            if(that.previousPlayRecordButton) {
              that.previousPlayRecordButton.icon = 'av:play-circle-outline';
            }

            if(that.currentPlayRecordButton) {
              that.currentPlayRecordButton.icon = 'av:play-circle-outline';
            }

            that.previousPlayRecordButton = that.currentPlayRecordButton;
          });
        },

        toggleItemDetailsDrawer: function () {
          this.$.innerDrawerPanel.togglePanel();
        },

        toggleMenuDrawer: function () {
          this.$.outerDrawerPanel.togglePanel();
        },

        playRecord : function(event, data, source) {

          this.currentPlayRecordButton = data;

          var audioFile = data.getAttribute("data-mp3");
          var audioFileName = data.getAttribute("data-title");

          console.log("playRecord: " + audioFileName);

          if (this.$.audioPlayer.name === audioFileName && this.$.audioPlayer.src === audioFile) {
            console.log("> togglePlay");
            this.$.audioPlayer.togglePlay();
          } else {
            console.log("> new file");
            this.$.audioPlayer.src = audioFile;
            this.$.audioPlayer.name = audioFileName;
          }
        },

        currentSectionChanged : function(oldValue, newValue){
          switch(this.currentSection) {
            case "languageSection":
              //setup languages list
              this.$.languagesList.setData({ displayLanguages: true });
              break;
            case "voicesSection":
              //setup voices list
              this.$.voicesList.setData({ displayVoices: true });
              break;
            case "mapSection":
              //setup map
              console.log("mapSection selected");
              break;
            case "searchSection":
              //close right panel when search is displayed - something like that, but nicer
              //this.$.itemDetailDrawer.setAttribute("hidden", "true");
              this.$.searchResultsListElement.setData({searchTerm: "river"});
              //setup search
              console.log("searchSection selected");
              break;
          }
        },

        categorySelected: function(e) {
          switch(this.currentSection) {
            case "languageSection":
              this.$.itemsListElement.setData( { language: e.detail });
              this.toggleItemDetailsDrawer();
              break;
            case "voicesSection":
              this.$.itemsListElement.setData( { voice: e.detail });
              this.toggleItemDetailsDrawer();
              break;
          }
        }
      })
    })();
  </script>

</polymer-element>
