<link rel="import" href="../uqlibrary-elements/0.5.4/lib/vulcanized-flint.html">
<link rel="import" href="uqlibrary-flint-items-core-list.html">
<link rel="import" href="uqlibrary-flint-categories-list.html">
<link rel="import" href="uqlibrary-flint-item.html">
<link rel="import" href="uqlibrary-flint-warning-dialog.html">

<polymer-element name="uqlibrary-flint">

    <template>
        <link rel="stylesheet" href="../uqlibrary-elements/resources/theme/element.css" shim-shadowdom>

        <uqlibrary-ga id="ga" appName="FlintCollection"></uqlibrary-ga>

        <core-drawer-panel id="outerDrawerPanel" responsiveWidth="1500px">
            <div drawer class="left-drawer">
                <uqlibrary-menu menuFile="flint.json"></uqlibrary-menu>
            </div>

            <core-drawer-panel id="innerDrawerPanel" main rightDrawer responsiveWidth="768px" drawerWidth="300px"
                               disableSwipe>
                <div id="itemDetailDrawer" drawer class="right-drawer">
                    <uqlibrary-flint-items-core-list id="itemsListElement"
                                                     on-close-button-clicked="{{toggleItemDetailsDrawer}}"
                                                     on-play-record-clicked="{{playRecord}}"></uqlibrary-flint-items-core-list>
                </div>
                <div main layout vertical relative class="main">
                    <core-toolbar>
                        <paper-icon-button icon="menu" id="hamburgerMenuButton" class="flint-responsive-menu-icon"
                                           on-tap="{{toggleMenuDrawer}}"></paper-icon-button>
                        <div class="glow">
                            <h1 flex id="toolbar-page-title">Indigenous Voices</h1>
                        </div>
                        <paper-icon-button icon="search" hidden id="search-btn"></paper-icon-button>
                        <div flex>
                            <paper-input-decorator label="Search" id="searchInput">
                                <input is="core-input" on-keypress="{{searchKeyPress}}">
                            </paper-input-decorator>
                        </div>
                        <paper-icon-button icon="cancel" id="cancel" class="cancelIconSlide" on-tap="{{retractSearch}}"></paper-icon-button>
                        <paper-icon-button icon="search" id="search" on-tap="{{expandSearch}}"></paper-icon-button>
                    </core-toolbar>

                    <paper-tabs selected="{{currentSection}}" valueattr="data-selected-section">
                        <paper-tab data-selected-section="mapSection" id="mapSection" on-tap="{{centerMapIfSelected}}">
                            <uqlibrary-a11y-link>Map</uqlibrary-a11y-link>
                        </paper-tab>
                        <paper-tab data-selected-section="languageSection">
                            <uqlibrary-a11y-link>Languages</uqlibrary-a11y-link>
                        </paper-tab>
                        <paper-tab data-selected-section="voicesSection">
                            <uqlibrary-a11y-link>Voices</uqlibrary-a11y-link></paper-tab>
                    </paper-tabs>

                    <core-animated-pages selected="{{currentSection}}" valueattr="data-selected-section"
                                         transitions="slide-from-right" flex id="animatedPages">
                        <section id="mapDisplaySection" data-selected-section="mapSection">
                            <uqlibrary-flint-categories-list id="mapList" showMap="true" on-category-selected="{{categorySelected}}"></uqlibrary-flint-categories-list>
                        </section>
                        <section id="languageListSection" data-selected-section="languageSection">
                            <uqlibrary-flint-categories-list id="languagesList" on-category-selected="{{categorySelected}}"></uqlibrary-flint-categories-list>
                        </section>
                        <section id="voiceListSection" data-selected-section="voicesSection">
                            <uqlibrary-flint-categories-list id="voicesList" on-category-selected="{{categorySelected}}"></uqlibrary-flint-categories-list>
                        </section>
                        <section id="searchSection" data-selected-section="searchSection" vertical layout>

                            <div style="height: 60px;" relative>
                                <div fit style="background-color: #fff; border: 0px #999 solid; border-width: 0px 0 0 0; box-shadow: 0 1px 4px 0px rgba(0, 0, 0, 0.37); text-align: center;">
                                    Search box goes here... <paper-button class="colored" on-tap="{{searchSubmitted}}">Search</paper-button>
                                    <!-- something like that:
                                    <uqlibrary-flint-search id="searchElement" on-search-submitted="{{searchSubmitted}}" />

                                    searchSubmitted: function(e) {
                                      this.$.searchResultsListElement.setData({searchTerm: e.data});
                                    }
                                    -->
                                </div>
                            </div>

                            <uqlibrary-flint-items-core-list id="searchResultsListElement"
                                                             on-play-record-clicked="{{playRecord}}" flex style="margin-top: 60px;"></uqlibrary-flint-items-core-list>
                        </section>
                    </core-animated-pages>

                </div>
            </core-drawer-panel>

        </core-drawer-panel>

        <uqlibrary-flint-warning-dialog autoOpen
                                        cancelRedirectUrl="https://www.library.uq.edu.au/fryer-library/"></uqlibrary-flint-warning-dialog>

    </template>

    <script>

        (function () {
            var     expandSearchFrame0 = 1,
                    expandSearchFrame1 = 250,
                    expandSearchFrame2 = 350,
                    expandSearchFrame3 = 450,
                    expandSearchFrame4 = 550,

                    retractSearchFrame0 = 1,
                    retractSearchFrame1 = 250,
                    retractSearchFrame2 = 350,
                    retractSearchFrame3 = 450,
                    retractSearchFrame4 = 550,

                    searchMinLength = 1;

            Polymer('uqlibrary-flint', {

                // Accessibility issues fixes
                keyboardNavigationKeys: 'space enter',
                a11yKeyPressed: function (source, event) {
                    if (source.path && source.path.length > 0 && source.path[0].target) {
                        source.path[0].target.fire("tap");
                    }
                },

                ready: function () {
                    var that = this;

                    var responsiveWidth = parseInt(this.$.innerDrawerPanel.responsiveWidth);

                    if (responsiveWidth > window.innerWidth) {
                        this.$.innerDrawerPanel.drawerWidth = "95%";
                    } else if (responsiveWidth <= window.innerWidth) {
                        this.$.innerDrawerPanel.drawerWidth = "50%";
                    }

                    window.addEventListener('resize', this.onWindowResize);

                    this.currentSection = "mapSection";

                    // Fix Google map bug when window is resized and map is hidden
                    this.$.animatedPages.addEventListener('core-animated-pages-transition-end', function() {
                        if (that.currentSection == "mapSection") {
                            that.$.mapList.resizeMap();
                        }
                    });
                },

                expandSearch: function () {
                    var that = this;

                    setTimeout(function() {
                        that.shadowRoot.querySelector('#hamburgerMenuButton').classList.toggle('iconSlide');
                    }, expandSearchFrame0);

                    setTimeout(function() {
                        that.shadowRoot.querySelector('#toolbar-page-title').classList.toggle('iconSlide');
                    }, expandSearchFrame1);

                    setTimeout(function() {
                        that.shadowRoot.querySelector('#hamburgerMenuButton').setAttribute('hidden', true);
                        that.shadowRoot.querySelector('#toolbar-page-title').setAttribute('hidden', true);
                    }, expandSearchFrame2);

                    setTimeout(function() {
                        that.shadowRoot.querySelector('#search').setAttribute('hidden', true);
                        that.shadowRoot.querySelector('#search').classList.toggle('iconSlide');
                        that.shadowRoot.querySelector('#searchInput').classList.toggle('slideIn');

                    }, expandSearchFrame3);

                    setTimeout(function() {
                        that.shadowRoot.querySelector('#cancel').classList.toggle('slideIn');
                        // TODO: search input should receive focus at this point
                    }, (expandSearchFrame4));


                },

                retractSearch: function () {
                    var that = this;
                    setTimeout(function() {
                        that.shadowRoot.querySelector('#cancel').classList.toggle('slideIn');

                    }, retractSearchFrame0);

                    setTimeout(function() {
                        that.shadowRoot.querySelector('#search').classList.toggle('iconSlide');
                        that.shadowRoot.querySelector('#searchInput').classList.toggle('slideIn');
                    }, (retractSearchFrame1));

                    setTimeout(function() {
                        that.shadowRoot.querySelector('#toolbar-page-title').removeAttribute('hidden');
                        that.shadowRoot.querySelector('#hamburgerMenuButton').removeAttribute('hidden');
                    }, retractSearchFrame2);

                    setTimeout(function() {
                        that.shadowRoot.querySelector('#search').removeAttribute('hidden');
                        that.shadowRoot.querySelector('#toolbar-page-title').classList.toggle('iconSlide');
                    }, retractSearchFrame3);

                    setTimeout(function() {
                        that.shadowRoot.querySelector('#hamburgerMenuButton').classList.toggle('iconSlide');
                    }, retractSearchFrame4);
                },

                centerMapIfSelected: function () {
                    if (this.currentSection === "mapSection") {
                        this.$.mapList.recenterMap();
                    }
                },

                toggleItemDetailsDrawer: function () {
                    this.$.innerDrawerPanel.togglePanel();
                },

                toggleMenuDrawer: function () {
                    this.$.outerDrawerPanel.togglePanel();
                },

                searchSubmitted: function(searchTerm) {
                    this.$.itemsListElement.setData({searchTerm: searchTerm});
                    this.toggleItemDetailsDrawer();
                },

                searchKeyPress: function(e) {
                    var key = e.which || e.keyCode;
                    if (key === 13) { // 13 is enter
                        if (e.target.value.length > searchMinLength) {
                            this.searchSubmitted(e.target.value);
                        }
                    }
                },

                currentSectionChanged : function(oldValue, newValue){
                    switch(this.currentSection) {
                        case "languageSection":
                            //setup languages list
                            this.$.languagesList.setData({ displayLanguages: true });
                            break;
                        case "voicesSection":
                            //setup voices list
                            this.$.voicesList.setData({ displayVoices: true });
                            break;
                        case "mapSection":
                            //setup map
                            this.$.mapList.setData({ displayLanguages: true });
                            break;
                        case "searchSection":
                            //TODO: search results are displayed in main area, right hand side drawer is not required
                            //close right panel when search is displayed - something like that, but nicer
                            //this.$.itemDetailDrawer.setAttribute("hidden", "true");
                            break;
                    }
                },

                categorySelected: function(e) {
                    switch(this.currentSection) {
                        case "mapSection":
                            this.$.itemsListElement.setData( { language: e.detail });
                            this.toggleItemDetailsDrawer();
                            break;
                        case "languageSection":
                            this.$.itemsListElement.setData( { language: e.detail });
                            this.toggleItemDetailsDrawer();
                            break;
                        case "voicesSection":
                            this.$.itemsListElement.setData( { voice: e.detail });
                            this.toggleItemDetailsDrawer();
                            break;
                    }
                }
            })
        })();
    </script>

</polymer-element>
